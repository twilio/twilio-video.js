version: '3'
# to build image
# BROWSER=chrome BVER=stable docker-compose build circleci
# to run image
# BROWSER=chrome BVER=stable docker-compose run circleci

# Travis has Docker Engine Version: 17.09.0-ce
# which does not support naming default networks.
# https://docs.docker.com/compose/compose-file/compose-versioning/#version-35
# networks:
#   default:
#    name: twilio-videojs_default

services:
  circleci:
    environment:
    - ENVIRONMENT=${ENVIRONMENT}
    - ACCOUNT_SID=${ACCOUNT_SID}
    - API_KEY_SID=${API_KEY_SID}
    - API_KEY_SECRET=${API_KEY_SECRET}
    - TOPOLOGY=${TOPOLOGY}
    # TODO fix this travis job number thing.
    - TRAVIS_JOB_NUMBER=42
    - BVER=stable
    user: root
    image: makarandp/twilio-video:${BROWSER}-${BVER}
    build:
      args:
      - USE_BROWSER=${BROWSER}
      - USE_BVER=${BVER}
      - USE_NETWORK=twilio-videojs_default
      context: .
      dockerfile: ./Dockerfile
    working_dir: /opt/app
    container_name: "twilio-video-${BROWSER}-${BVER}"
    volumes:
      - "../../:/opt/app"
      - /var/run/docker.sock:/var/run/docker.sock
      - /opt/app/node_modules
