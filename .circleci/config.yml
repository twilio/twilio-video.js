# to test any changes to job
# you can use
# circleci config process .circleci/config.yml > config_processed.yml
# followed by
# circleci local execute -c config_processed.yml --job chrome-stable-tests
version: 2.1
executors:
  docker-chrome-stable:
    docker:
      - image: makarandp/twilio-video:chrome-stable
    environment:
      BROWSER: "chrome"
      BVER: "stable"
      ENVIRONMENT: "prod"
  docker-ff-stable:
    docker:
      - image: makarandp/twilio-video:chrome-stable
    environment:
      BROWSER: "firefox"
      BVER: "stable"
      ENVIRONMENT: "prod"
  machine-executor:
    machine: true
    environment:
      BVER: "stable"
      ENVIRONMENT: "prod"
      # indicate that we want to run networking tests.
      NETWORK_TESTS: "true"

commands: # a reusable command with parameters
  get-code-and-dependancies:
    steps:
      - checkout
      - restore_cache: # special step to restore the dependency cache
          # Read about caching dependencies: https://circleci.com/docs/2.0/caching/
          key: dependency-cache-{{ checksum "package.json" }}
      - run:
          name: install dependancies
          command: npm install
      - save_cache: # special step to save the dependency cache
          key: dependency-cache-{{ checksum "package.json" }}
          paths:
            - ./node_modules
  build:
    steps:
      - get-code-and-dependancies
      - run:
          name: quick build
          command: npm run build:quick
  unit-tests:
    steps:
      - get-code-and-dependancies
      - run:
          name: run unit tests
          command: npm run cover
      - store_artifacts:
          path: ./coverage
          prefix: coverage
  integration-tests:
    steps:
      - get-code-and-dependancies
      - run: scripts/circleci-run-tests.sh
      - store_test_results:
          path: ./logs
      - store_artifacts:
          path: ./logs
          prefix: tests
  network-tests:
    steps:
      - checkout
      - run: scripts/circleci-run-tests.sh
      - store_test_results:
          path: ./logs
      - store_artifacts:
          path: ./logs
          prefix: tests
jobs:
  Build:
    executor: docker-chrome-stable
    steps:
      - build
  Unittest:
    executor: docker-chrome-stable
    steps:
      - unit-tests
  Chrome-stable-group:
    environment:
      TOPOLOGY: "group"
    executor: docker-chrome-stable
    steps:
      - integration-tests
  Chrome-stable-p2p:
    environment:
      TOPOLOGY: "peer-to-peer"
    executor: docker-chrome-stable
    steps:
      - integration-tests
  FF-stable-group:
    environment:
      TOPOLOGY: "group"
    executor: docker-ff-stable
    steps:
      - integration-tests
  FF-stable-p2p:
    environment:
      TOPOLOGY: "peer-to-peer"
    executor: docker-ff-stable
    steps:
      - integration-tests
  Chrome-network-group:
    environment:
      BROWSER: "chrome"
      TOPOLOGY: "group"
    executor: machine-executor
    steps:
      - network-tests
  Chrome-network-p2p:
    environment:
      BROWSER: "chrome"
      TOPOLOGY: "peer-to-peer"
    executor: machine-executor
    steps:
      - network-tests
  FF-network-group:
    environment:
      BROWSER: "firefox"
      TOPOLOGY: "group"
    executor: machine-executor
    steps:
      - network-tests
  FF-network-p2p:
    environment:
      BROWSER: "firefox"
      TOPOLOGY: "peer-to-peer"
    executor: machine-executor
    steps:
      - network-tests
workflows:
 version: 2
 Pull_Request_Workflow:
   jobs:
     - Build
     - Unittest
     - Chrome-stable-group:
        requires:
          - Build
          - Unittest
     - Chrome-stable-p2p:
        requires:
          - Build
          - Unittest
     - FF-stable-group:
        requires:
          - Build
          - Unittest
     - FF-stable-p2p:
        requires:
          - Build
          - Unittest
     - Chrome-network-group:
        requires:
          - Build
          - Unittest
     - Chrome-network-p2p:
        requires:
          - Build
          - Unittest
     - FF-network-group:
        requires:
          - Build
          - Unittest
     - FF-network-p2p:
        requires:
          - Build
          - Unittest
