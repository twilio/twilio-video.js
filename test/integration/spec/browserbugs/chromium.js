'use strict';

const { isChrome } = require('../../../lib/guessbrowser');

(isChrome ? describe : describe.skip)('Chromium bugs', () => {
  it('Bug 1127625', async () => {
    // Link: https://bugs.chromium.org/p/chromium/issues/detail?id=1127625
    const alice = new RTCPeerConnection();
    const bob = new RTCPeerConnection();
    alice.onicecandidate = e => e.candidate && bob.addIceCandidate(e.candidate);
    bob.onicecandidate = e => e.candidate && alice.addIceCandidate(e.candidate);

    // offer
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    alice.addTrack(stream.getTracks()[0], stream);
    const offer = await alice.createOffer();
    await bob.setRemoteDescription({ type: 'offer', sdp: offer.sdp.replace('m=audio 9 ', 'm=audio 0 ') });
    await alice.setLocalDescription(offer);
    const answer = await bob.createAnswer();
    await alice.setRemoteDescription(answer);
    await bob.setLocalDescription(answer);
    const nextOffer = await bob.createOffer();
    await bob.setLocalDescription(nextOffer);
  });

  it('Bug 1134686', async () => {
    // Link: https://bugs.chromium.org/p/chromium/issues/detail?id=1134686
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
    const pc = new RTCPeerConnection();
    // addTransceiver videotrack?
    pc.addTransceiver(stream.getVideoTracks()[0]);
    await pc.setLocalDescription();
    await pc.setRemoteDescription({ type: 'answer', sdp: 'v=0\r\no=mediasoup-client 10000 1 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\na=ice-lite\r\na=fingerprint:sha-512 B4:CA:28:51:44:78:54:41:0D:6F:EF:43:1F:A2:2C:A7:E1:B2:7A:05:D9:FB:B0:46:A6:0C:73:9A:2C:44:50:10:41:5C:EF:15:B8:56:45:22:5B:F4:A6:F5:A7:37:CA:2A:A2:B9:96:6C:2B:CB:71:5C:76:80:FC:38:75:66:AA:4F\r\na=msid-semantic: WMS *\r\na=group:BUNDLE 0\r\nm=video 7 UDP/TLS/RTP/SAVPF 96 97\r\nc=IN IP4 127.0.0.1\r\na=rtpmap:96 VP8/90000\r\na=rtpmap:97 rtx/90000\r\na=fmtp:96 x-google-start-bitrate=1000\r\na=fmtp:97 apt=96\r\na=rtcp-fb:96 transport-cc \r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack \r\na=rtcp-fb:96 nack pli\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:5 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\r\na=extmap:6 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:13 urn:3gpp:video-orientation\r\na=extmap:14 urn:ietf:params:rtp-hdrext:toffset\r\na=setup:active\r\na=mid:0\r\na=recvonly\r\na=ice-ufrag:ekmo7clqhx50a90q\r\na=ice-pwd:3pbt0tqreim1z6dvk24qxe7oznnmgve0\r\na=candidate:udpcandidate 1 udp 1076558079 167.71.103.231 29800 typ host\r\na=candidate:tcpcandidate 1 tcp 1076302079 167.71.103.231 56854 typ host tcptype passive\r\na=end-of-candidates\r\na=ice-options:renomination\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rid:r0 recv\r\na=rid:r1 recv\r\na=simulcast:recv r0;r1\r\n' });

    // addTransceiver audiotrack?
    pc.addTransceiver(stream.getAudioTracks()[0]);
    await pc.setLocalDescription();
    await pc.setRemoteDescription({ type: 'answer', sdp: 'v=0\r\no=mediasoup-client 10000 2 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\na=ice-lite\r\na=fingerprint:sha-512 B4:CA:28:51:44:78:54:41:0D:6F:EF:43:1F:A2:2C:A7:E1:B2:7A:05:D9:FB:B0:46:A6:0C:73:9A:2C:44:50:10:41:5C:EF:15:B8:56:45:22:5B:F4:A6:F5:A7:37:CA:2A:A2:B9:96:6C:2B:CB:71:5C:76:80:FC:38:75:66:AA:4F\r\na=msid-semantic: WMS *\r\na=group:BUNDLE 0 1\r\nm=video 7 UDP/TLS/RTP/SAVPF 96 97\r\nc=IN IP4 127.0.0.1\r\na=rtpmap:96 VP8/90000\r\na=rtpmap:97 rtx/90000\r\na=fmtp:96 x-google-start-bitrate=1000\r\na=fmtp:97 apt=96\r\na=rtcp-fb:96 transport-cc \r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack \r\na=rtcp-fb:96 nack pli\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:5 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\r\na=extmap:6 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:13 urn:3gpp:video-orientation\r\na=extmap:14 urn:ietf:params:rtp-hdrext:toffset\r\na=setup:active\r\na=mid:0\r\na=recvonly\r\na=ice-ufrag:ekmo7clqhx50a90q\r\na=ice-pwd:3pbt0tqreim1z6dvk24qxe7oznnmgve0\r\na=candidate:udpcandidate 1 udp 1076558079 167.71.103.231 29800 typ host\r\na=candidate:tcpcandidate 1 tcp 1076302079 167.71.103.231 56854 typ host tcptype passive\r\na=end-of-candidates\r\na=ice-options:renomination\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rid:r0 recv\r\na=rid:r1 recv\r\na=simulcast:recv r0;r1\r\nm=audio 7 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 127.0.0.1\r\na=rtpmap:111 opus/48000/2\r\na=fmtp:111 usedtx=1\r\na=rtcp-fb:111 transport-cc \r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\r\na=setup:active\r\na=mid:1\r\na=recvonly\r\na=ice-ufrag:ekmo7clqhx50a90q\r\na=ice-pwd:3pbt0tqreim1z6dvk24qxe7oznnmgve0\r\na=candidate:udpcandidate 1 udp 1076558079 167.71.103.231 29800 typ host\r\na=candidate:tcpcandidate 1 tcp 1076302079 167.71.103.231 56854 typ host tcptype passive\r\na=end-of-candidates\r\na=ice-options:renomination\r\na=rtcp-mux\r\na=rtcp-rsize\r\n' });

    // ??? mute audio
    pc.removeTrack(pc.getSenders()[1]);
    await pc.setLocalDescription();
    await pc.setRemoteDescription({ type: 'answer', sdp: 'v=0\r\no=mediasoup-client 10000 3 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\na=ice-lite\r\na=fingerprint:sha-512 B4:CA:28:51:44:78:54:41:0D:6F:EF:43:1F:A2:2C:A7:E1:B2:7A:05:D9:FB:B0:46:A6:0C:73:9A:2C:44:50:10:41:5C:EF:15:B8:56:45:22:5B:F4:A6:F5:A7:37:CA:2A:A2:B9:96:6C:2B:CB:71:5C:76:80:FC:38:75:66:AA:4F\r\na=msid-semantic: WMS *\r\na=group:BUNDLE 0\r\nm=video 7 UDP/TLS/RTP/SAVPF 96 97\r\nc=IN IP4 127.0.0.1\r\na=rtpmap:96 VP8/90000\r\na=rtpmap:97 rtx/90000\r\na=fmtp:96 x-google-start-bitrate=1000\r\na=fmtp:97 apt=96\r\na=rtcp-fb:96 transport-cc \r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack \r\na=rtcp-fb:96 nack pli\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:5 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\r\na=extmap:6 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:13 urn:3gpp:video-orientation\r\na=extmap:14 urn:ietf:params:rtp-hdrext:toffset\r\na=setup:active\r\na=mid:0\r\na=recvonly\r\na=ice-ufrag:ekmo7clqhx50a90q\r\na=ice-pwd:3pbt0tqreim1z6dvk24qxe7oznnmgve0\r\na=candidate:udpcandidate 1 udp 1076558079 167.71.103.231 29800 typ host\r\na=candidate:tcpcandidate 1 tcp 1076302079 167.71.103.231 56854 typ host tcptype passive\r\na=end-of-candidates\r\na=ice-options:renomination\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rid:r0 recv\r\na=rid:r1 recv\r\na=simulcast:recv r0;r1\r\nm=audio 0 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 127.0.0.1\r\na=rtpmap:111 opus/48000/2\r\na=fmtp:111 usedtx=1\r\na=rtcp-fb:111 transport-cc \r\na=setup:active\r\na=mid:1\r\na=inactive\r\na=ice-ufrag:ekmo7clqhx50a90q\r\na=ice-pwd:3pbt0tqreim1z6dvk24qxe7oznnmgve0\r\na=candidate:udpcandidate 1 udp 1076558079 167.71.103.231 29800 typ host\r\na=candidate:tcpcandidate 1 tcp 1076302079 167.71.103.231 56854 typ host tcptype passive\r\na=end-of-candidates\r\na=ice-options:renomination\r\na=rtcp-mux\r\na=rtcp-rsize\r\n' });

    // ??? unmute audio
    pc.addTrack(stream.getAudioTracks()[0]);
    await pc.setLocalDescription();
    await pc.setRemoteDescription({ type: 'answer', sdp: 'v=0\r\no=mediasoup-client 10000 4 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\na=ice-lite\r\na=fingerprint:sha-512 B4:CA:28:51:44:78:54:41:0D:6F:EF:43:1F:A2:2C:A7:E1:B2:7A:05:D9:FB:B0:46:A6:0C:73:9A:2C:44:50:10:41:5C:EF:15:B8:56:45:22:5B:F4:A6:F5:A7:37:CA:2A:A2:B9:96:6C:2B:CB:71:5C:76:80:FC:38:75:66:AA:4F\r\na=msid-semantic: WMS *\r\na=group:BUNDLE 0 2\r\nm=video 7 UDP/TLS/RTP/SAVPF 96 97\r\nc=IN IP4 127.0.0.1\r\na=rtpmap:96 VP8/90000\r\na=rtpmap:97 rtx/90000\r\na=fmtp:96 x-google-start-bitrate=1000\r\na=fmtp:97 apt=96\r\na=rtcp-fb:96 transport-cc \r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack \r\na=rtcp-fb:96 nack pli\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:5 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\r\na=extmap:6 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:13 urn:3gpp:video-orientation\r\na=extmap:14 urn:ietf:params:rtp-hdrext:toffset\r\na=setup:active\r\na=mid:0\r\na=recvonly\r\na=ice-ufrag:ekmo7clqhx50a90q\r\na=ice-pwd:3pbt0tqreim1z6dvk24qxe7oznnmgve0\r\na=candidate:udpcandidate 1 udp 1076558079 167.71.103.231 29800 typ host\r\na=candidate:tcpcandidate 1 tcp 1076302079 167.71.103.231 56854 typ host tcptype passive\r\na=end-of-candidates\r\na=ice-options:renomination\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rid:r0 recv\r\na=rid:r1 recv\r\na=simulcast:recv r0;r1\r\nm=audio 7 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 127.0.0.1\r\na=rtpmap:111 opus/48000/2\r\na=fmtp:111 usedtx=1\r\na=rtcp-fb:111 transport-cc \r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\r\na=setup:active\r\na=mid:2\r\na=recvonly\r\na=ice-ufrag:ekmo7clqhx50a90q\r\na=ice-pwd:3pbt0tqreim1z6dvk24qxe7oznnmgve0\r\na=candidate:udpcandidate 1 udp 1076558079 167.71.103.231 29800 typ host\r\na=candidate:tcpcandidate 1 tcp 1076302079 167.71.103.231 56854 typ host tcptype passive\r\na=end-of-candidates\r\na=ice-options:renomination\r\na=rtcp-mux\r\na=rtcp-rsize\r\n' });

    // ??? mute audio again
    await pc.setLocalDescription();
    await pc.setRemoteDescription({ type: 'answer', sdp: 'v=0\r\no=mediasoup-client 10000 5 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\na=ice-lite\r\na=fingerprint:sha-512 B4:CA:28:51:44:78:54:41:0D:6F:EF:43:1F:A2:2C:A7:E1:B2:7A:05:D9:FB:B0:46:A6:0C:73:9A:2C:44:50:10:41:5C:EF:15:B8:56:45:22:5B:F4:A6:F5:A7:37:CA:2A:A2:B9:96:6C:2B:CB:71:5C:76:80:FC:38:75:66:AA:4F\r\na=msid-semantic: WMS *\r\na=group:BUNDLE 0\r\nm=video 7 UDP/TLS/RTP/SAVPF 96 97\r\nc=IN IP4 127.0.0.1\r\na=rtpmap:96 VP8/90000\r\na=rtpmap:97 rtx/90000\r\na=fmtp:96 x-google-start-bitrate=1000\r\na=fmtp:97 apt=96\r\na=rtcp-fb:96 transport-cc \r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack \r\na=rtcp-fb:96 nack pli\r\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\r\na=extmap:5 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\r\na=extmap:6 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\r\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\r\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:13 urn:3gpp:video-orientation\r\na=extmap:14 urn:ietf:params:rtp-hdrext:toffset\r\na=setup:active\r\na=mid:0\r\na=recvonly\r\na=ice-ufrag:ekmo7clqhx50a90q\r\na=ice-pwd:3pbt0tqreim1z6dvk24qxe7oznnmgve0\r\na=candidate:udpcandidate 1 udp 1076558079 167.71.103.231 29800 typ host\r\na=candidate:tcpcandidate 1 tcp 1076302079 167.71.103.231 56854 typ host tcptype passive\r\na=end-of-candidates\r\na=ice-options:renomination\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rid:r0 recv\r\na=rid:r1 recv\r\na=simulcast:recv r0;r1\r\nm=audio 0 UDP/TLS/RTP/SAVPF 111\r\nc=IN IP4 127.0.0.1\r\na=rtpmap:111 opus/48000/2\r\na=fmtp:111 usedtx=1\r\na=rtcp-fb:111 transport-cc \r\na=setup:active\r\na=mid:2\r\na=inactive\r\na=ice-ufrag:ekmo7clqhx50a90q\r\na=ice-pwd:3pbt0tqreim1z6dvk24qxe7oznnmgve0\r\na=candidate:udpcandidate 1 udp 1076558079 167.71.103.231 29800 typ host\r\na=candidate:tcpcandidate 1 tcp 1076302079 167.71.103.231 56854 typ host tcptype passive\r\na=end-of-candidates\r\na=ice-options:renomination\r\na=rtcp-mux\r\na=rtcp-rsize\r\n' });

    const offer = await pc.createOffer();
    pc.setLocalDescription(offer); // will fail.
  });
});
