version: 2
jobs:
  unstable integration peer-to-peer tests on chrome(stable):
    docker:
    - image: twilio/twilio-video-browsers:chrome-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: unstable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  serversiderender tests:
    docker:
    - image: twilio/twilio-video-browsers:chrome-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Building Quick
        command: npm run build:quick
    - store_artifacts:
        path: ./dist
        prefix: dist
    - run:
        name: Running Server Side Render Tests
        command: npm run test:serversiderender
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
  unstable network group tests on firefox:
    machine:
      image: ubuntu-2004:202111-02
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: network
    - BVER: stable
    - BROWSER: firefox
    - TOPOLOGY: group
    - TEST_STABILITY: unstable
    steps:
    - checkout
    - run:
        name: Running Network Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable integration peer-to-peer tests on firefox(stable):
    docker:
    - image: twilio/twilio-video-browsers:firefox-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  Build-Docker-Test-Image-firefox-stable:
    machine:
      image: ubuntu-2004:202111-02
    steps:
    - checkout
    - run:
        name: Building Docker Image
        command: .circleci/images/build_docker_image.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - BROWSER: firefox
    - BVER: stable
  Build-Docker-Test-Image-firefox-beta:
    machine:
      image: ubuntu-2004:202111-02
    steps:
    - checkout
    - run:
        name: Building Docker Image
        command: .circleci/images/build_docker_image.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - BROWSER: firefox
    - BVER: beta
  Build-Docker-Test-Image-firefox-unstable:
    machine:
      image: ubuntu-2004:202111-02
    steps:
    - checkout
    - run:
        name: Building Docker Image
        command: .circleci/images/build_docker_image.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - BROWSER: firefox
    - BVER: unstable
  framework tests:
    docker:
    - image: twilio/twilio-video-browsers:chrome-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: framework
    - BROWSER: chrome
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Building Quick
        command: npm run build:quick
    - store_artifacts:
        path: ./dist
        prefix: dist
    - run:
        name: Running Framework Tests
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable integration group tests on chrome(unstable):
    docker:
    - image: twilio/twilio-video-browsers:chrome-unstable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: group
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  unstable integration group tests on firefox(stable):
    docker:
    - image: twilio/twilio-video-browsers:firefox-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: group
    - TEST_STABILITY: unstable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable network peer-to-peer tests on firefox:
    machine:
      image: ubuntu-2004:202111-02
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: network
    - BVER: stable
    - BROWSER: firefox
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: stable
    steps:
    - checkout
    - run:
        name: Running Network Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable integration peer-to-peer tests on firefox(unstable):
    docker:
    - image: twilio/twilio-video-browsers:firefox-unstable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  unstable integration peer-to-peer tests on firefox(stable):
    docker:
    - image: twilio/twilio-video-browsers:firefox-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: unstable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  unstable integration group tests on chrome(stable):
    docker:
    - image: twilio/twilio-video-browsers:chrome-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: group
    - TEST_STABILITY: unstable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable network group tests on chrome:
    machine:
      image: ubuntu-2004:202111-02
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: network
    - BVER: stable
    - BROWSER: chrome
    - TOPOLOGY: group
    - TEST_STABILITY: stable
    steps:
    - checkout
    - run:
        name: Running Network Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  Build-Docker-Test-Image-chrome-beta:
    machine:
      image: ubuntu-2004:202111-02
    steps:
    - checkout
    - run:
        name: Building Docker Image
        command: .circleci/images/build_docker_image.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - BROWSER: chrome
    - BVER: beta
  stable network peer-to-peer tests on chrome:
    machine:
      image: ubuntu-2004:202111-02
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: network
    - BVER: stable
    - BROWSER: chrome
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: stable
    steps:
    - checkout
    - run:
        name: Running Network Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable integration group tests on chrome(stable):
    docker:
    - image: twilio/twilio-video-browsers:chrome-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: group
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  UnitTests:
    docker:
    - image: twilio/twilio-video-browsers:chrome-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Unit Tests
        command: npm run test:unit
    - store_artifacts:
        path: ./coverage
        prefix: coverage
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
  stable integration peer-to-peer tests on chrome(beta):
    docker:
    - image: twilio/twilio-video-browsers:chrome-beta
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  unstable network group tests on chrome:
    machine:
      image: ubuntu-2004:202111-02
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: network
    - BVER: stable
    - BROWSER: chrome
    - TOPOLOGY: group
    - TEST_STABILITY: unstable
    steps:
    - checkout
    - run:
        name: Running Network Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  Build:
    docker:
    - image: twilio/twilio-video-browsers:chrome-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Building Quick
        command: npm run build:quick
    - store_artifacts:
        path: ./dist
        prefix: dist
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
  stable integration peer-to-peer tests on chrome(unstable):
    docker:
    - image: twilio/twilio-video-browsers:chrome-unstable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  umd tests:
    docker:
    - image: twilio/twilio-video-browsers:chrome-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - BROWSER: chrome
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Building Quick
        command: npm run build:quick
    - store_artifacts:
        path: ./dist
        prefix: dist
    - run:
        name: Installing UMD test dependencies
        command: npm run test:umd:install
    - run:
        name: Running UMD Tests
        command: npm run test:umd
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable integration group tests on firefox(unstable):
    docker:
    - image: twilio/twilio-video-browsers:firefox-unstable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: group
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  Build-Docker-Test-Image-chrome-stable:
    machine:
      image: ubuntu-2004:202111-02
    steps:
    - checkout
    - run:
        name: Building Docker Image
        command: .circleci/images/build_docker_image.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - BROWSER: chrome
    - BVER: stable
  stable integration peer-to-peer tests on chrome(stable):
    docker:
    - image: twilio/twilio-video-browsers:chrome-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable integration group tests on chrome(beta):
    docker:
    - image: twilio/twilio-video-browsers:chrome-beta
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: group
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable integration group tests on firefox(stable):
    docker:
    - image: twilio/twilio-video-browsers:firefox-stable
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: group
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable integration peer-to-peer tests on firefox(beta):
    docker:
    - image: twilio/twilio-video-browsers:firefox-beta
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  Build-Docker-Test-Image-chrome-unstable:
    machine:
      image: ubuntu-2004:202111-02
    steps:
    - checkout
    - run:
        name: Building Docker Image
        command: .circleci/images/build_docker_image.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - BROWSER: chrome
    - BVER: unstable
  unstable network peer-to-peer tests on firefox:
    machine:
      image: ubuntu-2004:202111-02
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: network
    - BVER: stable
    - BROWSER: firefox
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: unstable
    steps:
    - checkout
    - run:
        name: Running Network Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  trigger-qe-tests:
    docker:
    - image: circleci/node:latest
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    steps:
    - run:
        name: Trigger QE tests
        command: |
          curl --fail --write-out "\nHTTP Response Code: %{http_code}\n" \
          -u $CIRCLECI_PERSONAL_API_TOKEN: -X POST --header "Content-Type: application/json" \
          -d '{"branch":"'v${CIRCLE_TAG:0:1}'","parameters":{"sdk_version":"'$CIRCLE_TAG'","is_rc":true}}' \
          $SDKS_QE_CIRCLECI_VIDEO_JS_SLAVE_PIPELINE_ENDPOINT
  stable integration group tests on firefox(beta):
    docker:
    - image: twilio/twilio-video-browsers:firefox-beta
      auth:
        username: $DOCKER_HUB_USERNAME
        password: $DOCKER_HUB_PASSWORD
    parallelism: 6
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: integration
    - TOPOLOGY: group
    - TEST_STABILITY: stable
    - TEST_FILES: auto
    steps:
    - checkout
    - restore_cache:
        key: dependency-cache-{{ checksum "package.json" }}
    - run:
        name: Installing dependencies
        command: npm install --legacy-peer-deps
    - save_cache:
        key: dependency-cache-{{ checksum "package.json" }}
        paths:
        - ./node_modules
    - run:
        name: Running Integration Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  stable network group tests on firefox:
    machine:
      image: ubuntu-2004:202111-02
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: network
    - BVER: stable
    - BROWSER: firefox
    - TOPOLOGY: group
    - TEST_STABILITY: stable
    steps:
    - checkout
    - run:
        name: Running Network Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
  unstable network peer-to-peer tests on chrome:
    machine:
      image: ubuntu-2004:202111-02
    environment:
    - ENVIRONMENT: stage
    - ENABLE_REST_API_TESTS: 'true'
    - TEST_TYPE: network
    - BVER: stable
    - BROWSER: chrome
    - TOPOLOGY: peer-to-peer
    - TEST_STABILITY: unstable
    steps:
    - checkout
    - run:
        name: Running Network Tests (environment = stage)
        command: scripts/circleci-run-tests.sh
    - store_test_results:
        path: ./logs
    - store_artifacts:
        path: ./logs
        prefix: tests
workflows:
  version: 2
  Build_Docker_Images_Workflow:
    triggers:
    - schedule:
        cron: 0 0 * * *
        filters:
          branches:
            only:
            - master
    jobs:
    - Build-Docker-Test-Image-chrome-stable:
        context: dockerhub-push
    - Build-Docker-Test-Image-chrome-unstable:
        context: dockerhub-push
    - Build-Docker-Test-Image-chrome-beta:
        context: dockerhub-push
    - Build-Docker-Test-Image-firefox-stable:
        context: dockerhub-push
    - Build-Docker-Test-Image-firefox-unstable:
        context: dockerhub-push
    - Build-Docker-Test-Image-firefox-beta:
        context: dockerhub-push
  Pull_Request_Workflow:
    jobs:
    - Build:
        context: dockerhub-pulls
    - UnitTests:
        context: dockerhub-pulls
    - stable integration group tests on chrome(stable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration peer-to-peer tests on chrome(stable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration group tests on chrome(unstable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration peer-to-peer tests on chrome(unstable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration group tests on chrome(beta):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration peer-to-peer tests on chrome(beta):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration group tests on firefox(stable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration peer-to-peer tests on firefox(stable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration group tests on firefox(unstable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration peer-to-peer tests on firefox(unstable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration group tests on firefox(beta):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable integration peer-to-peer tests on firefox(beta):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - unstable integration group tests on chrome(stable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - unstable integration peer-to-peer tests on chrome(stable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - unstable integration group tests on firefox(stable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - unstable integration peer-to-peer tests on firefox(stable):
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable network group tests on chrome:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - unstable network group tests on chrome:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable network peer-to-peer tests on chrome:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - unstable network peer-to-peer tests on chrome:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable network group tests on firefox:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - unstable network group tests on firefox:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - stable network peer-to-peer tests on firefox:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - unstable network peer-to-peer tests on firefox:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - framework tests:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - umd tests:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
    - serversiderender tests:
        requires:
        - Build
        - UnitTests
        context: dockerhub-pulls
  Release-candidate:
    jobs:
    - trigger-qe-tests:
        filters:
          tags:
            only:
            - /^\d+\.\d+\.\d+-rc\d+$/
            - /^\d+\.\d+\.\d+-preview\d+-rc\d+$/
            - /^\d+\.\d+\.\d+-beta\d+-rc\d+$/
            - /^\d+\.\d+\.\d+-rc\.\d+$/
            - /^\d+\.\d+\.\d+-preview\d+-rc\.\d+$/
            - /^\d+\.\d+\.\d+-beta\d+-rc\.\d+$/
          branches:
            ignore: /.*/
        context:
        - sdks-qe
        - dockerhub-pulls
